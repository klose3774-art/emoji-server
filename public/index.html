<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoList</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f0f0; }
        .container { background-color: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); min-width: 300px; }
        form { display: flex; flex-direction: column; }
        input, textarea { margin-bottom: 1rem; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 0.5rem 1rem; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; margin-top: 0.5rem;}
        button:hover { background-color: #0056b3; }
        .error { color: red; margin-top: 1rem; text-align: center; }
        #mainMenu { display: none; }
        .button-secondary { background-color: #6c757d; }
        .button-secondary:hover { background-color: #5a6268; }
        .button-danger { background-color: #dc3545; }
        .button-danger:hover { background-color: #c82333; }
    </style>
</head>
<body>
<div class="container">

    <div id="loginView">
        <h1>Iniciar Sesi칩n</h1>
        <form id="loginForm">
            <label for="password">Contrase침a:</label>
            <input type="password" id="password" name="password" required>
            <button type="submit">Entrar</button>
        </form>
        <p id="loginErrorMessage" class="error"></p>
    </div>

    <div id="mainMenu">
        <h1>TodoList</h1>
        <form id="taskForm">
            <label for="title">Nueva tarea:</label>
            <input type="text" id="title" name="title" required>
            <button type="submit">Guardar</button>
        </form>
        <button id="viewMessagesBtn" class="button-secondary">Ver tareas</button>
        <button id="logoutBtn" class="button-danger">Cerrar sesi칩n</button>
    </div>

</div>

<script>
const loginView = document.getElementById('loginView');
const mainMenu = document.getElementById('mainMenu');
const loginForm = document.getElementById('loginForm');
const taskForm = document.getElementById('taskForm');
const viewMessagesBtn = document.getElementById('viewMessagesBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginErrorMessage = document.getElementById('loginErrorMessage');

function showView(view) {
    loginView.style.display = 'none';
    mainMenu.style.display = 'none';
    if (view === 'login') loginView.style.display = 'block';
    if (view === 'main') mainMenu.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const res = await fetch('/check-auth', { credentials: 'include' });
        const data = await res.json();
        showView(data.isAuthenticated ? 'main' : 'login');
    } catch {
        showView('login');
    }
});

loginForm.addEventListener('submit', async e => {
    e.preventDefault();
    loginErrorMessage.textContent = '';

    const password = e.target.password.value;

    const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ password })
    });

    if (res.ok) showView('main');
    else loginErrorMessage.textContent = 'Contrase침a incorrecta';
});

taskForm.addEventListener('submit', async e => {
    e.preventDefault();
    const title = e.target.title.value;

    const res = await fetch('/save-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title })
    });

    if (res.ok) {
        alert('Tarea guardada');
        e.target.reset();
    } else {
        alert('Error al guardar');
    }
});

viewMessagesBtn.addEventListener('click', () => {
    window.location.href = '/messages.html';
});

logoutBtn.addEventListener('click', async () => {
    await fetch('/logout', { method: 'POST', credentials: 'include' });
    showView('login');
});
</script>
</body>
</html>